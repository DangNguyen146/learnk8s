<match kong_access.**>
        @type record_reformer
        enable_ruby true
        # <record>
            lat_request     ${record['latencies']['request']}
            lat_proxy       ${record['latencies']['proxy']}

            # service_name         ${record['service']['name']}

            request_size    ${record['request']['size']}
            request_uri     ${record['request']['uri']}

            # x-real-ip       ${record['request']['headers']['x-real-ip']}
            # x-forwarded-for ${record['request']['headers']['x-forwarded-for']}
            # user-agent      ${record['request']['headers']['user-agent']}

            method          ${record['request']['method']}
            # balancer_ip     ${record['tries'][0]['ip']}
            # balancer_port   ${record['tries'][0]['port']}
            status          ${record['response']['status']}
            size            ${record['response']['size']}
            route_name     ${if record['upstream_uri'] == ""; "index";else; record['route']['name'] ;end;}
            
        # </record>

	    # remove_keys latencies
	    # remove_keys service
	    # remove_keys request
	    # remove_keys tries
	    # remove_keys route
	    # remove_keys started_at
        skip_adding_null_record true
        tag kong_out_access

</match>

<filter kong_out_access.**>
    @type script
    path /data/www/config/scripts/script/kong.rb
</filter>
<match kong_out_access.**>
    @type copy
    <store>
        @type file
        format json
        @log_level error
        path /data/td-agent/logs/prod/access/kong_api_access
        time_slice_format %Y%m%d
        time_slice_wait 10m
        time_format %Y-%m-%dT%H:%M:%S.%3N%z
        #include_time_key true
        compress gzip
        buffer_type file
        buffer_chunk_limit 1024m
        buffer_queue_limit 10240
        buffer_path /data/td-agent/logs/prod/buffer/buffer_kong_api_access
        disable_retry_limit false
        retry_limit 17
        retry_wait 1s
    </store>
    <store>
        @type elasticsearch
        @log_level error
        host 172.16.5.47
        # user td-agent
        # password aJtK29az9mzTSMi
        port 9200
        logstash_format true
        type_name log
        logstash_prefix kong_access_prod
        verify_es_version_at_startup false
        default_elasticsearch_version 7
        #buffer_type memory
        buffer_type file
        buffer_chunk_limit 1024m
        buffer_queue_limit 10240
        buffer_path /data/td-agent/logs/prod/buffer/buffer_elasticsearch_kong_api_access
        flush_interval 5s
        #retry_limit 17
        retry_timeout 72h
        retry_forever false
        retry_wait 1
        num_threads 1
        request_timeout 45s
    </store>
</match>
